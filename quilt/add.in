#! @BASH@

#  This script is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License version 2 as
#  published by the Free Software Foundation.
#
#  See the COPYING and AUTHORS files for more details.

# Read in library functions
if [ "$(type -t patch_file_name)" != function ]
then
	if ! [ -r @SCRIPTS@/patchfns ]
	then
		echo "Cannot read library @SCRIPTS@/patchfns" >&2
		exit 1
	fi
	. @SCRIPTS@/patchfns
fi

usage()
{
	echo $"Usage: quilt add [-p patch] {file} ..."
	if [ x$1 = x-h ]
	then
		echo $"
Add one or more files to the topmost or named patch.  Files must be
added to the patch before being modified.  Files that are modified by
patches on top of the specified patch cannot be added.

-p patch
	Patch to add files to."

		exit 0
	else
		exit 1
	fi
}

options=`getopt -o p:h -- "$@"`

if [ $? -ne 0 ]
then
	usage
fi

eval set -- "$options"

while true
do
	case "$1" in
	-p)
		if ! patch=$(find_patch $2)
		then
			echo $"Patch $2 is not in series" >&2
			exit 1
		fi
		shift 2 ;;
	-h)
		usage -h ;;
	--)
		shift
		break ;;
	esac
done

if [ $# -lt 1 ]
then
	usage
fi

if [ -n "$patch" ]
then
	if ! is_applied $patch
	then
		echo $"Patch $patch is not applied" >&2
		exit 1
	fi
else
	patch=$(top_patch)
	if [ -z "$patch" ]
	then
		echo $"No patches applied" >&2
		exit 1
	fi
fi

status=0
for file in $*
do
	if file_in_patch $SUBDIR$file $patch
	then
		echo $"File $SUBDIR$file is already in patch $patch"
		status=2
		continue
	fi
	next_patch=$(next_patch_for_file $patch $SUBDIR$file)
	if [ -n "$next_patch" ]
	then
		echo $"File $SUBDIR$file modified by patch $next_patch"
		status=1
		continue
	fi

	if ! @LIB@/backup-files -s -L -B $QUILT_PC/$patch/ $SUBDIR$file
	then
		echo $"Failed to back up file $SUBDIR$file" >&2
		status=1
		continue
	fi

	if [ -e $SUBDIR$file ]
	then
		# The original tree may be read-only.
		chmod u+w $SUBDIR$file
	fi

	echo $"File $SUBDIR$file added to patch $patch"
done
exit $status
### Local Variables:
### mode: shell-script
### End:
# vim:filetype=sh
